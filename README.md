
# Kubernetes on your own infrastructure

*Don't want to pay for the cloud? You just love to use your
own hardware? Tired of creating VMs for
each of your apps? Want to web-scale without making config mess?
Try kubernetes!* But let me show you how

1. Install [docker](https://kubernetes.io/docs/setup/production-environment/container-runtimes/#docker)
2. Install [kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/).
This is a administration tool for kubernetes. It lets you create
clusters, join to other ones etc.
3. [Create the master cluster](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)

	- `kubeadm init`
	- let your non root user use kubectl

	  ```bash
	  mkdir -p $HOME/.kube
	  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
	  sudo chown $(id -u):$(id -g) $HOME/.kube/config
	  ```

	  Also, copy this the same way to your computer .kube/config, so you can control
	  kubernetes using kubectl from your own computer

	- Make the master be worker `kubectl taint nodes --all node-role.kubernetes.io/master-`
	- Install a pod network add on (we'll use flannel)
	`kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml`

	- Install `helm` on your machine where you use kubectl. This is a kubernetes
	package manager.

	- If you aren't behind a cloud load balancer, install metallb.
	This will is a software load balancer that will asign external IPs to
	your Ingress controllers or other services
	that need it. Create a config `metallb-values.yml`.
	See file in this repo. Put there the external IP adresses you have available.
	`helm install metallb bitnami/metallb -f metallb-values.yml --namespace=metallb-system`

	- Install an ingress controller. This is a thing that publishes your services
	to the external network world. Some of them manage https certificates
	automatically too! We will use ingress-nginx, which can do it.
	In the command I also have some things that will allow us to make a metrics
	dashboard for the ingress controller.

4. First we'll install cert-manager for managing TLS certificates that will
be generated by Let's encrypt.

`kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.2.0/cert-manager.yaml`

5. Then we'll install the ingress controller itself.

```bash
helm install ingress-nginx ingress-nginx/ingress-nginx --namespace ingress-nginx \
  --set controller.metrics.enabled=true \
  --set-string controller.podAnnotations."prometheus\.io/scrape"="true" \
  --set-string controller.podAnnotations."prometheus\.io/port"="10254"
```

6. Now when you should see the external ip assigned to the controller LoadBalancer service:
`kubectl -n ingress-nginx get svc`

7. Create certificate issuer resources for cert-manager. These are essentialy config
files that tell cert-manager how to obtain a certificate. You mainly need to specify
your email in them if you want to use let's encrypt.

Look at my file `prod_issuer.yaml`. Change the email and apply it. Also,
remember the name `letsencrypt-prod`. You will need to type that when defining
ingress resources. ( This is a config file that tells ingress-nginx to proxy
to a parteticular service when a request with a parteticular host comes in. )

## Nginx ingress grafana metrics dashboard (optional)

1. First install prometheus (metrics tracking and logging, publishes an API):
`kubectl apply --kustomize github.com/kubernetes/ingress-nginx/deploy/prometheus/`

2. create a DNS A record for the prometheus server

3. Publish the service by creating an ingress resource
(see and customize `prometheus-ingress.yaml`) and applying it:
`kubectl apply -f prometheus-ingress.yaml`

4. Install grafana (web dashboard with charts)
`kubectl apply --kustomize github.com/kubernetes/ingress-nginx/deploy/grafana/`

5. Make DNS for grafana, publish the service the same way as previously
(see grafana-ingress.yaml)

6. Go to the domain and configure grafana (see [this](https://xaviergeerinck.com/post/infrastructure/kubernetes-nginx-ingress-controller-monitoring-prometheus)
When adding the prometheus datasource, select client side scraping. Server side
gives me 503 errors for some reason.

## Private docker registry (optional)

This is good if you don't want to have your docker images public on the Docker hub.
See the directory `dockerreg` on how to set it up.
